<!-- Hi guys, this code uses the bulk of the code from molSimplify Lite. I have added buttons for solvent and thermal stability, and an upload button that communicates with an input html object. Visualization can be done directly from an uploaded cif file. An example MOF is prepared by default, using fetch and a node hosting of local files. 

In order to get code to work, use Safari and select Develop -> Disable Cross-Origin Restrictions.

In two terminals, navigate to folder containing app.py
First, in one terminal, run node node.js (this is to make the example MOF available)
Then, to open the website, run python app.py in the second terminal

-->


<!-- Import NGL, webGavrog, and Bootstrap libaries--> 
<script src="libraries/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="libraries/ngl.js"></script>
<script type="text/javascript" src="libraries/webGavrog/runtime.js"></script>
<script type="text/javascript" src="libraries/webGavrog/vendors.js"></script>
<script type="text/javascript" src="libraries/webGavrog/main.js"></script>
<script src="libraries/3Dmol-min.js"></script>
<script src="libraries/bootstrap.min.js"></script>

<!-- Import CSS -->
<link rel="stylesheet" href="libraries/bootstrap.min.css">
<link rel="stylesheet" href="libraries/bootstrap_custom.min.css">


<!-- Custom CSS code is placed within the <style> tag: -->
<style>
.btn {
  margin-top: 3px;
}

.viewportwrapper {

}

.cifviewport {

}

.mol-container {
  width: 100%;
  height: 400px;
  position: relative;
}

.form-control {
  margin-bottom:0.1cm;
}

#viewportwrapper { grid-area: viz; } /* Gianmarco Terrones addition, for MOF visualization */

</style>


<!-- Empty head section: place meta tags and favicon here -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> <!-- Gianmarco addition, debugging -->


<title>mofSimplify</title> 
<meta name="description" content="mofSimplify is an online interface to molSimplify, an open source, Python-based utility created by the Kulik group at MIT for the Machine-Learning accelerated generation, prediction, and design of transition metal (coordination) complexes and MOFs." /> 
<meta property="og:type" content="website" />
<meta property="og:description" content="mofSimplify is an online interface to molSimplify, an open source, Python-based utility created by the Kulik group at MIT for the Machine-Learning accelerated generation, prediction, and design of transition metal (coordination) complexes and MOFs." /> 
<meta property="og:title" content="mofSimplify" /> 
<meta property="og:image" content="https://molsimplify.mit.edu/logo.png" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://molsimplify.mit.edu/logo.png" />

</head>


<body>

    <!-- The following code creates a navbar. Each navbar item is in a list entry of class "nav-item". -->
    <div class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary">
      <div class="container">
        <a href="../" class="navbar-brand">molSimplify</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="about.html">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/hjkgrp/molSimplify">Source Code</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://molsimplify.readthedocs.io/en/latest/Installation.html">Installation Instructions</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="http://hjkgrp.mit.edu/molSimplify-tutorials">Tutorials</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://molsimplify.readthedocs.io/en/latest/">Documentation</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="how_to_cite.html">How to Cite</a>
            </li>
          </ul>

        </div>
      </div>
    </div>

    <div class="container">
      <div class="page-header" id="banner">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-sm-12">
            <!-- Title -->
            <h1>mofSimplify <span style="font-size: 24px;">  (powered by <a href="https://molsimplify.readthedocs.io/en/latest/">molSimplify</a> from the <a href="http://hjkgrp.mit.edu/">Kulik group</a> at MIT!) </span></h1>
            <!-- Subtitle -->
            <p class="lead">Predict and view structures and properties of MOFs in your browser below!</p>
            
            <!-- Lead text -->
            <p>For more geometries, properties, and functionality, check out the full molSimplify utility. Learn more in the <a href="about.html">About</a> tab.</p>
          </div>
        </div>
      </div>

  <div class='row'>
    <!-- Create a column containing MOF viewer and buttons -->
    <div class='col-lg-6'>

        <div id="viewportwrapper" style="border-style: solid;" class="content inactive"> <!-- Gianmarco Terrones addition -->
          <div id="viewportnote" style="position: relative; top: 13em; text-align: center; z-index: 2;">(MOFs are visualized here. Left click to rotate, right click with mouse to move, scroll with mouse to zoom.)</div>
          <div id="cifviewport" style="width:534px; height:406px;"></div>
        </div>
        <div style="margin-bottom:0.5cm;"></div>
        <button class='btn btn-primary' id='load' type="button">Load example MOF</button>
        <button class='btn btn-primary' id='visualize' type="button">Visualize MOF</button>
    </div>
    
    <!-- Create a column containing selection boxes and buttons -->
    <div class='col-lg-6'>

        <div style="margin-bottom:0.5cm;"></div>

        A way for the user to generate MOFs for analysis, using a topological MOF net and nodular and connecting building blocks (bb).


        <!-- Selection box for Axial Ligand 1 (gets replaced immediately by JavaScript code) -->
        <div  style="padding-top: 30px">
          Linker, the connecting building block
          <input id="linker_option" class='form-control locksMetrics' list = 'linkers_list' onmousedown="value = '';" />
            <option value>Option 1 TODO</option>
            <option value>Option 2 TODO</option>
        </div>

        <!-- Default linkers -->
        <datalist id = 'linkers_list'>
            <option value="1B_4H_Ch">
            <option value="3B_4H_Ch">
        </datalist>


        <!-- Selection box for metal -->
        <div>
          sbu, the metal-centered nodular building block 
          <input id="sbu_option" class='form-control locksMetrics' list = 'sbus_list' onmousedown="value = '';" />
            <option value>Option 1 TODO</option>
            <option value>Option 2 TODO</option>
        </div>

        <!-- Default sbus -->
        <datalist id = 'sbus_list'>
            <option value="4c_Cd_1_Ch">
            <option value="6c_Zn_1_Ch">
            <option value="6c_Al_1">
            <option value="4c_Cu_1_Ch">
        </datalist>
        
        <div>
          MOF Net (selection)
          <select class='form-control locksMetrics' id="nets_option">
            <option value='cdl'>cdl</option>
            <option value='cds'>cds</option>
            <option value='crr'>crr</option>
          </select>
        </div>

        <button class='btn btn-primary' id='generate' type="button">Make bb-generated MOF</button>
        <button class='btn btn-primary' id='download_generated' type="button">Download bb-generated MOF</button>



      <div style="margin-top:1cm;"></div>
        <!-- Button for uploading MOF cif file -->
        <button class='btn btn-primary' id='upload' type="button">Upload MOF cif file</button>

        <!-- Button for getting MOF components for visualization  -->
        <button class='btn btn-primary' id='get_components' type='button'>Get MOF components</button>

        <!-- Button for predicting solvent removal stability of MOF -->
        <button class='btn btn-primary' id='predict_s' type="button">Predict stability upon solvent removal</button> <!-- Gianmarco Terrones addition -->
        <!-- Button for predicting thermal stability of MOF -->
        <button class='btn btn-primary' id='predict_t' type="button">Predict thermal stability</button> <!-- Gianmarco Terrones addition -->

      </div>
    </div>
    <!-- Empty spot where the MOF prediction text is placed. -->
    <div class='row' style='margin-top: 0.5cm;'>
        <b> Status messages and MOF predictions </b>
        <div class='col-12' id='upload_status'></div> <!-- Gianmarco Terrones addition -->
        <div class='col-12' id='status_visualization'></div> <!-- Gianmarco Terrones addition -->
        <div class='col-12' id='solvent_stability_prediction'></div> <!-- Gianmarco Terrones addition -->
        <div class='col-12' id='thermal_stability_prediction'></div> <!-- Gianmarco Terrones addition -->
        <div class='col-6' id='loading'></div>
        <div class='col-6' id='chart'></div>
    </div>


  <div class='row'>
    <div class='col-lg-6' style='margin-top: 0.5cm;'>
      <div id='container-01' class='mol-container' style='border-style:solid;border-width:2px;'>
          <div id='container-01-note' style='position: relative; top: 13em; text-align: center; z-index: 2;'>(MOF linkers and sbus are visualized here. Left click to rotate, scroll with mouse to zoom.)</div>
        </div>
      <div style="margin-bottom:0.5cm;"></div>
      <button class='btn btn-primary' id='visualize_linker' type='button'>Visualize linker</button>
      <button class='btn btn-primary' id='visualize_sbu' type='button'>Visualize sbu</button>
      <button class='btn btn-primary' id='reset' type='button'>Reset zoom level</button>

    </div>

    <div class='col-lg-6' style='margin-top: 0.5cm;'>

      <p> Can display MOF's linkers and sbus after clicking the Get MOF Components button. Select the desired linker or sbu, then click Visualize linker or Visualize sbu.</p>
      <div>
        Linkers
        <select class='form-control' id='linker'>
        </select>
      </div>

      <div>
        sbus
        <select class='form-control' id='sbu'> </select>
      </div>

      <button class='btn btn-primary' id='toggle_unique_components' type='button'>Only components with unique connectivities</button>

    </div>

  </div>

</div>





<div class="navbar navbar-expand-lg relative navbar-dark bg-primary" style="margin-top: 50px;">
  <div class="container">
      <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link disabled">Site developed and maintained by the Kulik Group at MIT</a>
          </li>
      </ul>
  </div>
</div>

<!-- For cif file upload -->
 <input id="fileinput" type="file" name="fileinput" style="display:none"/>  <!-- Gianmarco Terrones addition -->
<!-- This will never display anything. Just used to store a MOF cif file if the button "Upload MOF file" is used -->

<!-- For example MOF file -->
<p id="exampleholder"> </p> <!-- This will never display anything. Just used to store a MOF cif file if the button "Load example MOF" is used -->

<!-- For building block-generated MOF file -->
<p id="bbgMOFholder"> </p> <!-- This will never display anything. Just used to store a MOF cif file if the button "Load example MOF" is used -->


<!-- For MOF components (xyz file text) -->
<p id="componentsholder"> </p> <!-- This will never display anything. Just used to store a MOF if the button "Make bb-generated MOF" is used TODO -->

</body>



<!-- Begin JavaScript section -->
<script>
  // lots of this code is from sbu.html at https://github.com/snurr-group/web-mofid, for MOF visualization

  // beginning of section with a lot of copied code


  var stage;

  var lsdir = function(path) {
    return FS.readdir(path).filter(function(e) {
      return !['..', '.'].includes(e);  // filter out current and parent dirs
    }).sort();
  };

  // Adapted from examples at http://nglviewer.org/ngl/api/manual/usage/embedding.html
  // and https://codepen.io/pen?template=JNLMXb and http://nglviewer.org/ngldev/api/manual/snippets.html
  document.addEventListener("DOMContentLoaded", function () {
    stage = new NGL.Stage("cifviewport");
    stage.setParameters( {backgroundColor: "white"} );
  });

  var runMOFidCode = function(cifdata) {
    C_obcode = Module.cwrap(
      'analyzeMOFc', 'null', ['string', 'number', 'number']
    );

    if(!FS.analyzePath('/Output').exists) {
      FS.mkdir('/Output');  // See also docs on filesystem API: https://kripken.github.io/emscripten-site/docs/api_reference/Filesystem-API.html
      // Ideally, the C_obcode executable would automatically make all of the directories,
      // but it's broken at least in an old version of Emscripten.
      FS.mkdir('/Output/MetalOxo');
      FS.mkdir('/Output/SingleNode');
      FS.mkdir('/Output/AllNode');
      FS.mkdir('/Output/StandardIsolated');
    }

    var buflen = 65536;
    var ptr = Module._malloc(buflen);
    var buffer= new Uint8Array(Module.HEAPU8.buffer, ptr, buflen); // Get a bytes view on the newly allocated buffer.
    C_obcode(cifdata, ptr, buflen);
    var ans = Module.UTF8ToString(ptr);
    Module._free(ptr);
    return ans;
  };

  var analyzeMOF = function(input_cif_str, cif_name) {
    // Get relevant MOFid/MOFkey information from an input string of CIF-formatted coordinates
    var raw_mofid_output = runMOFidCode(input_cif_str);
    var single_node_topology = getTopology("/Output/SingleNode/topology.cgd");
    var all_node_topology = getTopology("/Output/AllNode/topology.cgd");

    // Extract the MOFid, per run_mofid.py:cif2mofid
    const fragment_info = _extractFragments(raw_mofid_output);
    let mofid_topology = '';
    if (fragment_info.cat == null) {
      mofid_topology = 'NA'
    } else if (single_node_topology == all_node_topology) {
      mofid_topology = single_node_topology;
    } else {
      mofid_topology = single_node_topology + ',' + all_node_topology;
    }

    let mof_name = cif_name;
    if (cif_name.endsWith('.cif') || cif_name.endsWith('.CIF')) {
      mof_name = cif_name.substring(0, cif_name.length - 4);
    }
    const all_fragments = fragment_info.nodes.concat(fragment_info.linkers);
    all_fragments.sort();

    // Assembling the MOFid from id_constructor.py:assemble_mofid
    let mofid = all_fragments.join('.');
    mofid += ' MOFid-v1.';
    mofid += mofid_topology + '.';
    if (fragment_info.cat == 'no_mof') {
      mofid += fragment_info.cat
    } else if (fragment_info.cat != null) {
      mofid += 'cat' + fragment_info.cat;
    } else {
      mofid += 'NA';
    }
    if (mofid.startsWith(' ')) {  // Null linkers.  Make .smi compatible
      mofid = '*' + mofid + 'no_mof';
    }
    mofid += ';' + mof_name;

    // Extract the MOFkey
    var base_mofkey = "";
    if (fragment_info.parsed) {
      base_mofkey = FS.readFile("/Output/MetalOxo/mofkey_no_topology.txt", {'encoding': 'utf8'});
    }
    var mofkey = base_mofkey.replace('MOFkey-v1', 'MOFkey-v1.' + single_node_topology);

    return {
      raw_output: raw_mofid_output,
      mofid: mofid,
      mofkey: mofkey,
      fragments: fragment_info
    };
  }

  var _extractFragments = function(raw_mofid_output) {
    // Parse the MOFid output, per id_constructor.py:extract_fragments
    let all_fragments = raw_mofid_output.trim().split(/\r\n|\r|\n/g);
    all_fragments = all_fragments.map(a => a.trim());
    if (all_fragments == '') {
      return {nodes: ['*'], linkers: [], cat: cat, parsed: false};
    }

    const cat_num_line = all_fragments.pop();
    let cat = null;
    if (cat_num_line.includes('simplified net(s)')) {
      cat = (parseInt(cat_num_line[8]) - 1).toString();  // '# Found x simplified net(s)'
      if (cat == '-1') {
        cat = null;
      }
    } else {
      all_fragments = ['*'];
    }

    // Parse node/linker fragment notation
    if (all_fragments[0] != '# Nodes:') {
      return {nodes: ['*'], linkers: [], cat: cat, parsed: false};
    }
    all_fragments.shift();
    const linker_flag_loc = all_fragments.findIndex(line => (line == "# Linkers:"));
    const node_fragments = all_fragments.slice(0, linker_flag_loc);
    const linker_fragments = all_fragments.slice(linker_flag_loc+1);
    node_fragments.sort();
    linker_fragments.sort();

    return {nodes: node_fragments, linkers: linker_fragments, cat: cat, parsed: true};
  }

  var rawToSmiles = function(raw_mofid) {
    // Converts the raw output from the MOFid code to a parseable SMILES format
    var lines = raw_mofid.replace(/\t/g, '').split(/\r\n|\r|\n/g);  // remove trailing tabs before splitting
    lines.pop();  // remove line about number of simplified nets
    return lines.join('.');
  }

  handleInput = function() {
    if (document.getElementById("fileinput").files[0] == null) {
      var ciffile = document.getElementById("exampleholder").value;
    }
    else {
      var ciffile = document.getElementById("fileinput").files[0];
    }

    
    //document.getElementById("obresults").innerHTML = "<code>Processing " + ciffile.name + "</code>";
    var cifreader = new FileReader();
    cifreader.onload = function(event) {
      var mofid_results = analyzeMOF(event.target.result, ciffile.name);
      if (mofid_results.fragments.parsed) {
        const mofid_html = "<div>MOFid:<br /><code>" + mofid_results.mofid + "</code></div>";
        const mofkey_html = "<div>MOFkey:<br /><code>" + mofid_results.mofkey + "</code></div>";
        //document.getElementById("obresults").innerHTML = mofid_html + mofkey_html;

        //clearDropdown("cifdownload");
        updateFileLists();  // populate the initial list of files
        //document.getElementById("folderdownload").selectedIndex = "0";  // back to the orig_mol

        //document.getElementById("resultsdownload").classList.remove("inactive");
        document.getElementById("viewportnote").style.display = "none";
        document.getElementById("viewportwrapper").classList.remove("inactive");


        clearViewer(stage);
        drawEmPDB(stage, "/Output/orig_mol.pdb");
      } else {
        //document.getElementById("obresults").innerHTML = "<pre>Failed to calculate MOFid components</pre>";
        //document.getElementById("resultsdownload").classList.add("inactive");
        document.getElementById("viewportwrapper").classList.add("inactive");
      }
    };
    cifreader.readAsText(ciffile);
  }

  getTopology = function(path_to_cgd) {
    // Extract topology from a generated CGD simplified net
    const raw_rcsr_extract = FS.readFile("/RCSRnets.arc", {'encoding': 'utf8'});
    const raw_cgd = FS.readFile(path_to_cgd, {'encoding': 'utf8'});
    if (!raw_cgd.includes('NODE')) {
      return "ERROR";  // not a MOF: no node building blocks found!
    } else {
      return webGavrog.getRawRCSRTopology(raw_cgd, raw_rcsr_extract);
    }
  }



  updateFileLists = function() {
    //clearDropdown("cifdownload");
    var folder_name = "";//getInputValue("folderdownload");
    var selected_view_index = "none";//document.getElementById("view_type").selectedIndex;

    var filelist;
    var view_value_list = ["original", "nodes_and_linkers", "simplified_net"];
    var view_name_list = ["Original MOF", "Nodes + Linkers", "Simplified topology"];
    if (folder_name == "") {  // original base directory
      filelist = ["orig_mol.cif", "orig_mol.pdb"];
      // Only keeping the original MOF in the viewer types:
      view_value_list = [view_value_list[0]];
      view_name_list = [view_name_list[0]];
      selected_view_index = "0";
    } else {
      filelist = lsdir("/Output/" + folder_name);
      // Removing the original MOF from the viewer types:
      view_value_list.shift();
      view_name_list.shift();
    }
    if (folder_name == "AllNode") {
      // Separate linkers into branches + branch points for the AllNode algorithm
      view_value_list[0] = "nodes_and_branches";
    }

  }


  clearViewer = function(ngl_stage) {
    ngl_stage.removeAllComponents();
  }

  addPDBtoViewer = function(ngl_stage, path_to_cif, color_scheme = "element") {
    var component;
    ngl_stage.loadFile(path_to_cif, {ext: "pdb"}).then( function( o ){
      o.addRepresentation("ball+stick", {colorScheme: color_scheme});
      o.addRepresentation( "unitcell" );
      o.autoView();
      /* See class documentation at http://nglviewer.org/ngl/api/class/src/stage/stage.js~Stage.html */
      /* See also the general documentation at http://nglviewer.org/ngl/api/manual/ */
    } );
    return component;
  }

  drawEmPDB = function(ngl_stage, emscripten_path, color_scheme = "element") {
    var cif_string = FS.readFile(emscripten_path, {'encoding': 'utf8'});
    var temp_file = new Blob([cif_string], {type: 'chemical/x-cif'});
    return addPDBtoViewer(ngl_stage, temp_file, color_scheme);
  }

  UniformColor = function(hex_color = 0x000000) {
    return NGL.ColormakerRegistry.addScheme(function(params) {
      this.atomColor = function(atom) {
        return hex_color;
      }
    });
  }


  var statusElement = document.getElementById('status_visualization');
  //var progressElement = document.getElementById('progress');
  //var spinnerElement = document.getElementById('spinner');

  var Module = {
    preRun: [],
    postRun: [], 
    print: (function() {
      var element = document.getElementById('output');
      if (element) element.value = ''; // clear browser cache
      return function(text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        // These replacements are necessary if you render to raw HTML
        //text = text.replace(/&/g, "&amp;");
        //text = text.replace(/</g, "&lt;");
        //text = text.replace(/>/g, "&gt;");
        //text = text.replace('\n', '<br>', 'g');
        console.log(text);
        if (element) {
          element.value += text + "\n";
          element.scrollTop = element.scrollHeight; // focus on bottom
        }
      };
    })(),
    printErr: function(text) {
      if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
      if (0) { // XXX disabled for safety typeof dump == 'function') {
        dump(text + '\n'); // fast, straight to the real console
      } else {
        console.error(text);
      }
    },
    canvas: (function() {

      // As a default initial behavior, pop up an alert when webgl context is lost. To make your
      // application robust, you may want to override this behavior before shipping!
      // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2

      return null;
    })(),
    setStatus: function(text) {
      if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
      if (text === Module.setStatus.text) return;
      var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
      var now = Date.now();
      if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
      if (m) {
        text = m[1];
        //progressElement.value = parseInt(m[2])*100;
        //progressElement.max = parseInt(m[4])*100;
        //progressElement.hidden = false;
        //spinnerElement.hidden = false;
      } //else {
        //progressElement.value = null;
        //progressElement.max = null;
        //progressElement.hidden = true;
        //if (!text) spinnerElement.style.display = 'none';
      //}
      statusElement.innerHTML = text;
    },
    totalDependencies: 0,
    monitorRunDependencies: function(left) {
      this.totalDependencies = Math.max(this.totalDependencies, left);
      Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
    }
  };
  Module.setStatus('Downloading...');
  window.onerror = function(event) {
    Module.setStatus('Exception thrown in visualization, see JavaScript console and refresh page (refreshing fixes the OOM, or out of memory, error).');
    //spinnerElement.style.display = 'none';
    Module.setStatus = function(text) {
      if (text) Module.printErr('[post-exception status] ' + text);
    };

  };

  // end of section with a lot of copied code


  $(function() {


    // Set up 3Dmol viewer 
    let element = $('#container-01');
    let config = { backgroundColor: 'white' };
    let component_viewer = $3Dmol.createViewer( element, config );
    data = {};

    // Reset zoom level
    $('#reset').click(function() {
      component_viewer.zoomTo();
    })


    // Upload MOF cif file  <!-- Gianmarco Terrones addition -->
    $(function() {
      $('#upload').on('click', function() { // button triggers upload
        $('#fileinput').trigger('click'); // OS file selection
      });
    });


    // Used for ensuring that only .cif files are uploaded  <!-- Gianmarco Terrones addition -->
    function getExtension(filename) {
      var parts = filename.split('.');
      return parts[parts.length - 1];
    }

    // Used for ensuring that only .cif files are uploaded   <!-- Gianmarco Terrones addition -->
    function isCif(filename) {
      var ext = getExtension(filename);
      return ext == 'cif';
    }

    $("#fileinput").change(function () { // once file has been uploaded   <!-- Gianmarco Terrones addition -->
        // clearing previous predictions
        //$('status').text(''); // clearing any visualization error messages from prior runs
        $('#solvent_stability_prediction').text('');
        $('#thermal_stability_prediction').text('');


        $('#upload_status').text(''); // now nothing is uploaded
        document.getElementById('exampleholder').value = null; // clears example cif
        document.getElementById('componentsholder').value = undefined; // clearing the value, so no component visualization is possible
        document.getElementById('toggle_unique_components').textContent = 'Only components with unique connectivities'; // setting button text

        // check if uploaded file is a .cif
        if (! isCif(this.value)) { // if the uploaded file is not a cif
            this.value = null; // clear the non-cif file
            alert("Must be a cif file.");
            return; // if not a cif, doesn't continue     
        }

        let myFile = document.getElementById('fileinput').files[0]; // the uploaded file
        $('#upload_status').text('File uploaded: ' + myFile.name);

        clearViewer(stage); // no MOF is displayed in the visualizer now
        component_viewer.clear(); // likewise, clear component visualizer
        clear_component_dropdowns();

        // re-display messages in the two visualizers
        document.getElementById('viewportnote').style.display = 'block';
        document.getElementById('viewportnote').innerHTML = '(MOFs are visualized here. Left click to rotate, right click with mouse to move, scroll with mouse to zoom.)';
        document.getElementById('container-01-note').innerHTML = '(MOF linkers and sbus are visualized here. Left click to rotate, scroll with mouse to zoom.)';
    });

    $("#visualize").on('click', function() {
        let myFile = document.getElementById('fileinput').files[0]; // the uploaded file
        let myFile2 = document.getElementById('exampleholder').value; // the example MOF, if Load example MOF has been used
        let myFile3 = document.getElementById('bbgMOFholder').value; // the generated MOF, if Make bb-generated MOF has been used

        // If neither the example MOF has been loaded, nor has the user uploaded nor generated a MOF, then an alert is raised and the function exits.
        if (myFile == null && myFile2 == null && myFile3 == null) {
          alert("Must upload a cif file first.");
          return;
        }

        alert('Visualization loading, may take up to 30 seconds. Close this alert after reading.') // based on NaX.cif

        document.getElementById("viewportnote").innerHTML = "Loading visualization...";

        handleInput(); // handles visualization, will display the MOF in the appropriate box (viewportwrapper)

        $('#loading').text('');
        $('#chart').text('');
    })

    // Generate solvent removal stability prediction
    $('#predict_s').click(function() {  // <!-- Gianmarco Terrones addition -->
      // check if a cif is uploaded
      let myFile = document.getElementById('fileinput').files[0]; // the uploaded file
      let myFile2 = document.getElementById('exampleholder').value; // the example MOF, if Load example MOF has been used
      let myFile3 = document.getElementById('bbgMOFholder').value; // the generated MOF, if Make bb-generated MOF has been used


      // If neither the example MOF has been loaded, nor has the user uploaded nor generated a MOF, then an alert is raised and the function exits.
      if (myFile==undefined) {
        myFile = myFile2;
        if (myFile2 == undefined) {
          myFile = myFile3;
          if (myFile3 == undefined) {
            alert("Must upload/generate a cif file first.");
            return;  
          }
        }
      }

      alert('Prediction loading, please wait for a few seconds. Close this alert after reading.') 

      // myFile.text() is a promise
      myFile.text().then(function(result){
        // result is the text of the loaded .cif file

        $.post("/predict_solvent_stability", JSON.stringify(result)).done(
            function(response) {

                  if (response == 'FAILED') { // (!response.ok) || 
                      alert('Failed to featurize')
                      //$('#solvent_stability_prediction').text('Solvent stability prediction failed.');
                    return; // Do not update solvent stability prediction if prediction failed
                  }

                  // var result = JSON.parse(response);
                  // console.log('check Q')
                  // console.log(result)
                  // console.log(result.sbu_0)

                  console.log('check Q')
                  console.log(response)

                  // preparing the human-interpretable solvent removal stability prediction
                  if (response <= 0.2) {
                    verdict = 'Very confident the MOF is unstable upon solvent removal.';
                  }
                  else if (response <= 0.4) {
                    verdict = 'Fairly confident the MOF is unstable upon solvent removal.';
                  }
                  else if (response <= 0.5) {
                    verdict = 'Uncertain, but predict the MOF is unstable upon solvent removal.';
                  }
                  else if (response <= 0.6) {
                    verdict = 'Uncertain, but predict the MOF is stable upon solvent removal.';
                  }
                  else if (response <= 0.8) {
                    verdict = 'Fairly confident the MOF is stable upon solvent removal.';
                  }
                  else {
                    verdict = 'Very confident the MOF is stable upon solvent removal.';
                  }

                  $('#solvent_stability_prediction').text('The solvent removal stability prediction is: ' + response.toString() + '. ' + verdict ); 
            });
      })
    });

    // Generate thermal stability prediction
    $('#predict_t').click(function() {  // <!-- Gianmarco Terrones addition -->
      // check if a cif is uploaded
      let myFile = document.getElementById('fileinput').files[0]; // the uploaded file
      let myFile2 = document.getElementById('exampleholder').value; // the example MOF, if Load example MOF has been used
      let myFile3 = document.getElementById('bbgMOFholder').value; // the generated MOF, if Make bb-generated MOF has been used


      // If neither the example MOF has been loaded, nor has the user uploaded nor generated a MOF, then an alert is raised and the function exits.
      if (myFile==undefined) {
        myFile = myFile2;
        if (myFile2 == undefined) {
          myFile = myFile3;
          if (myFile3 == undefined) {
            alert("Must upload/generate a cif file first.");
            return;  
          }
        }
      }

      alert('Prediction loading, please wait for a few seconds. Close this alert after reading.') 

      // myFile.text() is a promise
      myFile.text().then(function(result){
        // result is the text of the loaded .cif file

        $.post("/predict_thermal_stability", JSON.stringify(result)).done(
            function(response) {

                  if (response == 'FAILED') { // (!response.ok) || 
                      alert('Failed to featurize')
                      //$('#solvent_stability_prediction').text('Solvent stability prediction failed.');
                    return; // Do not update solvent stability prediction if prediction failed
                  }

                  console.log('check R')
                  console.log(response)

                  $('#thermal_stability_prediction').text('The thermal stability prediction is: Thermal breakdown at ' + response.toString()); 
            });
      })
    });


    // Generate MOF from building blocks
    $('#generate').click(function() {
      my_linker = $('#linker_option').val() // Check which linker is selected in the linker building block construction dropdown 
      my_sbu = $('#sbu_option').val() // Check which sbu is selected in the sbu building block construction dropdown 
      my_net = $('#nets_option').val() // Check which net is selected in the net building block dropdown 

      console.log('Check G')
      console.log(my_linker)
      console.log(my_sbu)
      console.log(my_net)

      if (my_linker === '') {
        alert("Must choose a linker building block first.");
        return;  
      }
      else if (my_sbu === '') {
        alert("Must choose an sbu building block first.");
        return;  
      }

      $('#upload_status').text(''); // now nothing is uploaded
      document.getElementById('exampleholder').value = null; // clears example cif
      document.getElementById('componentsholder').value = undefined; // clearing the value, so no component visualization is possible
      document.getElementById('toggle_unique_components').textContent = 'Only components with unique connectivities'; // setting button text


      bb_information = {}; // a dictionary
      bb_information.linker = my_linker;
      bb_information.sbu = my_sbu;
      bb_information.net = my_net;

      $.post("/get_bb_generated_MOF", JSON.stringify(bb_information)).done(
          function(response) {

            if (response == 'FAILED') { 
              alert('Failed to generate MOF')
              document.getElementById('bbgMOFholder').value = undefined; // clearing the value, so no component visualization is possible
              return; 
            }

            var result = JSON.parse(response);

            var name = result.mof_name;
            var bbMOF = result.mof_info;

            console.log('Check H')
            console.log(name)
            console.log(bbMOF)

            var blob = new Blob([bbMOF], { // TODO check if this works
              type: 'text/plain'
            });
            console.log(blob)
            console.log(blob.text())
            
            // debugging
            blob.text().then(function(result){
              console.log(result)
            });


            var myFile = new File([blob], name, {type: "", lastModified: Date.now()}); // making a cif file
            console.log(myFile)
            document.getElementById('bbgMOFholder').value = myFile; //bbMOF


            $('#solvent_stability_prediction').text(''); // clearing predictions
            $('#thermal_stability_prediction').text('');
            document.getElementById('fileinput').value = null; // clearing any cifs loaded by the user
            document.getElementById('componentsholder').value = undefined; // clearing the value, so no component visualization is possible
            clearViewer(stage); // clearing MOF visualizer
            component_viewer.clear(); // clearing component visualizer
            clear_component_dropdowns();


            // re-displaying messages inside the two visualizers
            document.getElementById('viewportnote').style.display = 'block';
            document.getElementById('viewportnote').innerHTML = '(MOFs are visualized here. Left click to rotate, right click with mouse to move, scroll with mouse to zoom.)';
            document.getElementById('container-01-note').innerHTML = '(MOF linkers and sbus are visualized here. Left click to rotate, scroll with mouse to zoom.)';

            $('#upload_status').text('MOF generated with building blocks: ' + name); // TODO make possible for multiple linkers and sbus?

        });
    });  


      // Load example MOF
    $('#load').click(function() {
      // clearing all display fields
      //$('status').text(''); // clearing any visualization error messages from prior runs
      $('#loading').text('');
      $('#solvent_stability_prediction').text('');
      $('#thermal_stability_prediction').text('');
      document.getElementById('fileinput').value = null; // clearing any cifs loaded by the user
      document.getElementById('componentsholder').value = undefined; // clearing the value, so no component visualization is possible
      document.getElementById('toggle_unique_components').textContent = 'Only components with unique connectivities'; // setting button text

      // for fetch to work, need to open a separate terminal, go to the folder containing index.html, and run node node.js
      fetch('http://localhost:5001/mof_examples/LIWVIY_clean.cif').then(response => { // grabbing the example MOF from local host
        if(!response.ok) { // catching 404 and other issues
          throw Error(response.statusText);
        } 
          return response.blob();
        }).then(function(blob) {
          var myFile = new File([blob], "example.cif", {type: "", lastModified: Date.now()}) // making a cif file
          document.getElementById('exampleholder').value = myFile; // setting the value of exampleholder
          $('#upload_status').text('File uploaded: Example MOF cif file (cleaned LIWVIY from CoRE2019)'); // indicating that the example MOF has been uploaded
          clearViewer(stage); // clearing MOF visualizer
          component_viewer.clear(); // clearing component visualizer
          clear_component_dropdowns();


          // re-displaying messages inside the two visualizers
          document.getElementById('viewportnote').style.display = 'block';
          document.getElementById('viewportnote').innerHTML = '(MOFs are visualized here. Left click to rotate, right click with mouse to move, scroll with mouse to zoom.)';
          document.getElementById('container-01-note').innerHTML = '(MOF linkers and sbus are visualized here. Left click to rotate, scroll with mouse to zoom.)';


        }).catch(error => {
          $('#upload_status').text('Failed to upload example MOF');
          console.error('There has been a problem with your fetch operation:', error);
        })      
    });


    // Get MOF linkers and sbus
    // Returns a dictionary of linkers and sbus, also includes information about number of linkers and sbus
    $('#get_components').click(function() {
      // check if a cif is uploaded
      let myFile = document.getElementById('fileinput').files[0]; // the uploaded file
      let myFile2 = document.getElementById('exampleholder').value; // the example MOF, if Load example MOF has been used
      let myFile3 = document.getElementById('bbgMOFholder').value; // the generated MOF, if Make bb-generated MOF has been used


      // If neither the example MOF has been loaded, nor has the user uploaded nor generated a MOF, then an alert is raised and the function exits.
      if (myFile==undefined) {
        myFile = myFile2;
        if (myFile2 == undefined) {
          myFile = myFile3;
          if (myFile3 == undefined) {
            alert("Must upload/generate a cif file first.");
            return;  
          }
        }
      }

      // myFile.text() is a promise
      myFile.text().then(function(result){
        // result is the text of the loaded .cif file
        $.post("/get_components", JSON.stringify(result)).done(
          function(response) {

            if (response == 'FAILED') { 
              alert('Failed to featurize')
              document.getElementById('componentsholder').value = undefined; // clearing the value, so no component visualization is possible
              return; 
            }

            var result = JSON.parse(response);
            console.log('check Q')
            console.log(typeof result)
            console.log(result)
            console.log(result.sbu_0)


            clear_component_dropdowns();
            var linker_dropdown = document.getElementById("linker");
            var sbu_dropdown = document.getElementById("sbu");

            num_linkers = result.total_linkers;
            num_sbus = result.total_sbus;

            // populating linker dropdown
            for (i = 1; i <= num_linkers; i++) {
              var option = document.createElement('option');
              option.text = 'Linker ' + i.toString();
              linker_dropdown.add(option);
            }

            // populating sbu dropdown
            for (i = 1; i <= num_sbus; i++) {
              var option = document.createElement('option');
              option.text = 'sbu ' + i.toString();
              sbu_dropdown.add(option);
            }

            // storing the linker and sbu data
            document.getElementById('componentsholder').value = result; //convert(result);

        });
      })
    });
    

    function clear_component_dropdowns() { // clear dropdowns when upload new file, and reshow message in 3dmol viewer
      // clearing linker dropdown
      var linker_dropdown = document.getElementById("linker");
      var length = linker_dropdown.options.length;
      for (i = length-1; i >= 0; i--) {
        linker_dropdown.options[i] = null;
      }

      // clearing sbu dropdown
      var sbu_dropdown = document.getElementById("sbu");
      var length = sbu_dropdown.options.length;
      for (i = length-1; i >= 0; i--) {
        sbu_dropdown.options[i] = null;
      }
    }

    $('#toggle_unique_components').click(function() {

      // Ensure there are components to visualize
      if (document.getElementById('componentsholder').value == undefined) {
        alert('Must get MOF components first.');
        return;
      }

      clear_component_dropdowns();

      // find the dropdowns
      var linker_dropdown = document.getElementById("linker");
      var sbu_dropdown = document.getElementById("sbu");

      if (document.getElementById('toggle_unique_components').textContent == 'Only components with unique connectivities') {
        document.getElementById('toggle_unique_components').textContent = 'All components'; // cycle the button text on click

        // getting the unique indices
        unique_linker_indices = document.getElementById('componentsholder').value.unique_linker_indices;
        unique_sbu_indices = document.getElementById('componentsholder').value.unique_sbu_indices;

        // populating linker dropdown
        for (i in unique_linker_indices) {
          j = parseInt(i) + 1; // due to 1 vs 0 indexing; Aditya's code zero indexes, but for web display we 1 index
          var option = document.createElement('option');
          option.text = 'Linker ' + j.toString(); 
          linker_dropdown.add(option);
        }

        // populating sbu dropdown
        for (i in unique_sbu_indices) {
          j = parseInt(i) + 1; // due to 1 vs 0 indexing; Aditya's code zero indexes, but for web display we 1 index
          var option = document.createElement('option');
          option.text = 'sbu ' + j.toString(); 
          sbu_dropdown.add(option);
        }


      }
      else if (document.getElementById('toggle_unique_components').textContent == 'All components') {
        document.getElementById('toggle_unique_components').textContent = 'Only components with unique connectivities'; // cycle the button text on click

        // getting the total number of linkers and sbus
        num_linkers = document.getElementById('componentsholder').value.total_linkers;
        num_sbus = document.getElementById('componentsholder').value.total_sbus;

        // populating linker dropdown
        for (i = 1; i <= num_linkers; i++) {
          var option = document.createElement('option');
          option.text = 'Linker ' + i.toString();
          linker_dropdown.add(option);
        }

        // populating sbu dropdown
        for (i = 1; i <= num_sbus; i++) {
          var option = document.createElement('option');
          option.text = 'sbu ' + i.toString();
          sbu_dropdown.add(option);
        }

      }

    })


    // Visualize the linker after MOF components have been resolved
    $('#visualize_linker').click(function() {

      // Ensure there are components to visualize
      if (document.getElementById('componentsholder').value == undefined) {
        alert('Must get MOF components first.');
        return;
      }

      my_linker = $('#linker').val() // Check which linker is selected in the linker dropdown 
      linker_number = my_linker.split(" "); // an array, split at the space
      linker_number = parseInt(linker_number[1]); // gets the number
      linker_number = linker_number - 1; // due to 1 vs 0 indexing; Aditya's code zero indexes, but for web display we 1 index

      // getting xyz data
      dictionary = document.getElementById('componentsholder').value;
      my_key = 'linker_' + linker_number;

      geometry = dictionary[my_key];  

      $('#container-01-note').text('');
      component_viewer.clear();
      component_viewer.addModel(geometry, "xyz");
      component_viewer.setStyle({}, {stick:{radius:0.25}});
      component_viewer.zoomTo();
      component_viewer.render();
    })


    // Visualize the sbu after MOF components have been resolved
    $('#visualize_sbu').click(function() {

      // Ensure there are components to visualize
      if (document.getElementById('componentsholder').value == undefined) {
        alert('Must get MOF components first.');
        return;
      }

      my_sbu = $('#sbu').val() // Check which sbu is selected in the linker dropdown 
      sbu_number = my_sbu.split(" "); // an array, split at the space
      sbu_number = parseInt(sbu_number[1]); // gets the number
      sbu_number = sbu_number - 1; // due to 1 vs 0 indexing; Aditya's code zero indexes, but for web display we 1 index

      // getting xyz data
      dictionary = document.getElementById('componentsholder').value;
      my_key = 'sbu_' + sbu_number;

      geometry = dictionary[my_key];

      $('#container-01-note').text('');
      component_viewer.clear();
      component_viewer.addModel(geometry, "xyz");
      component_viewer.setStyle({}, {stick:{radius:0.25}});
      component_viewer.zoomTo();
      component_viewer.render();

    })


    // Make a neural network prediction (the display text is defined in app.py)
    // $('#predict').click(function() {
    //   data.ox = $('#ox').val()
    //   data.hfx = $('#hfx').val()
    //   data.metal = $('#metal').val()
    //   data.ax1 = $('#ligand').val()
    //   data.ax2 = $('#ligand').val()
    //   data.eq = $('#ligand').val()
    //   data.spin = $('#spin').val()
    //   $('#loading').html('loading...');
    //   $.post("/nn_predict", JSON.stringify(data)).done(function(response){
    //     data.sseplot = response.result; // Set the sseplot value used for plotting
    //     if (data.sseplot != 'Error') {
    //       unlockPlot();
    //     }
    //     $("#loading").html(response.resulttext);
    //     document.getElementById('loading').scrollIntoView();
    //     });
    // });

    // Define the behavior of the download button
    $('#download').click(function() {
      function download(filename, text) {
          var element = document.createElement('a');
          element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
          element.setAttribute('download', filename);

          element.style.display = 'none';
          document.body.appendChild(element);

          element.click();

          document.body.removeChild(element);
      }
      download('mol.xyz', data.geometry);
    });

    // Start up page by virtually clicking the "Load example MOF" button
    $('#load').click();
  });


  // $('#plot').click(function() {
  //   // For testing.
  //   // data.sseplot = -15 
  //   $.post("/plot", JSON.stringify(data)).done(function(response) { 
  //     $('#chart').html(response)
  //   })
  // });

  // $('#plot_pca').click(function() {
  //   // For testing
  //   // data.ox = -2
  //   // data.hfx = 0.2
  //   // data.sseplot = -15
  //   $.post("/plotpca", JSON.stringify(data)).done(function(response) { 
  //     $('#chart').html(response)
  //   })
  // });

</script>

<!-- sbu.js is pulled from https://github.com/snurr-group/web-mofid, for visualization purposes. Not all of the code in it is used by our website. -->
<script async type="text/javascript" src="libraries/sbu.js"></script> 

